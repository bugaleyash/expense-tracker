<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Expense Tracker</h1>

    <!-- Expense Form -->
    <form id="expense-form">
        <input type="text" id="title" placeholder="Title" required>
        <input type="text" id="category" placeholder="Category" required>
        <input type="number" step="0.01" id="amount" placeholder="Amount" required>
        <input type="date" id="date" required>
        <button type="submit">Add Expense</button>
    </form>

    <!-- Total Amount -->
    <h3>Total: ₹<span id="totalAmount">0</span></h3>

    <!-- Expense Table -->
    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="expense-list"></tbody>
    </table>

    <!-- JavaScript -->
    <script>
    const expenseForm = document.getElementById("expense-form");
    const expenseList = document.getElementById("expense-list");
    const totalAmountEl = document.getElementById("totalAmount");

    let editingId = null;

    // Load All Expenses
    async function loadExpenses() {
        const res = await fetch("/api/expenses/getall");
        const data = await res.json();
        renderExpenses(data);
    }

    // Render Expenses
    function renderExpenses(expenses) {
        expenseList.innerHTML = "";
        let total = 0;

        expenses.forEach(expense => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${expense.title}</td>
                <td>${expense.category}</td>
                <td>₹${expense.amount}</td>
                <td>${expense.date}</td>
                <td>
                    <button onclick="editExpense(${expense.id}, '${expense.title}', '${expense.category}', ${expense.amount}, '${expense.date}')">Edit</button>
                    <button onclick="deleteExpense(${expense.id})">Delete</button>
                </td>
            `;
            expenseList.appendChild(row);
            total += parseFloat(expense.amount);
        });

        totalAmountEl.textContent = total.toFixed(2);
    }

    // Add or Update Expense
    expenseForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const expense = {
            title: document.getElementById("title").value.trim(),
            category: document.getElementById("category").value.trim(),
            amount: parseFloat(document.getElementById("amount").value),
            date: document.getElementById("date").value
        };

        let url = "/api/expenses/add";
        let method = "POST";

        if (editingId) {
            url = `/api/expenses/update?id=${editingId}`;
            method = "PUT";
        }

        const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(expense)
        });

        if (res.ok) {
            loadExpenses();
            expenseForm.reset();
            editingId = null;
        } else {
            alert("Failed to save expense");
        }
    });

    // Delete Expense
    async function deleteExpense(id) {
        const res = await fetch(`/api/expenses/delete?id=${id}`, { method: "DELETE" });
        if (res.ok) loadExpenses();
    }

    // Edit Expense
    function editExpense(id, title, category, amount, date) {
        editingId = id;
        document.getElementById("title").value = title;
        document.getElementById("category").value = category;
        document.getElementById("amount").value = amount;
        document.getElementById("date").value = date;
    }

    // Find by ID
    async function findById() {
        const id = document.getElementById("searchId").value;
        if (!id) return alert("Enter ID to search");

        const res = await fetch(`/api/expenses/getbyid?id=${id}`);
        if (res.ok) {
            const expense = await res.json();
            renderExpenses([expense]);
        } else {
            alert("Expense not found");
        }
    }

    // Find by Category
    async function findByCategory() {
        const category = document.getElementById("searchCategory").value.trim();
        if (!category) return alert("Enter category to search");

        const res = await fetch(`/api/expenses/category?category=${category}`);
        if (res.ok) {
            const data = await res.json();
            renderExpenses(data);
        }
    }

    // Initial load
    loadExpenses();
</script>

</body>
</html>
